# [jplbot](https://github.com/zhmylove/jplbot)

## основной код бота ([jplbot.pl](https://github.com/zhmylove/jplbot/blob/master/src/jplbot.pl))

|строки| код   |
|---------|------------------------------------|
|4 - 19| указываются зависимости от других файлов с помощью use |
|21 - 28| выполняется `config.pl`, результат заносится в `$rc`. Если `config` не распарсился или не вернул результат — выводится ошибка. |
|32 - 57| с помощью `my` объявляются локальные переменные (а с помощью `our` — глобальные). Значения берутся из `config` файла|
|59 - 68| `store` пишет хэш в файл(и в обратном направлении). Если нет файла saytofile, то туда записывается пустой хэш. Аналогичнос `kick_file` и хэшем `{ zhmylove => 1}` (`=>` используется при инициализации хэшей, отделяя ключ от значения). Далее хэш из `$saytofile` грузится в `%sayto`. Аналогично в `%kicks` грузится `$kick_file`. Далее в консоль выводятся ключи хэшей (при условии, что в хэшах что-то имеется). После создается объект класса `karma` (класс определен в karma.pm), в качестве параметра конструктора передается `config`. После создается объект класса `tome` и у него вызывается метод `read_tome_file` (`->` - разыменование ссылки, т. е. `${$ref}{some}` то же самое, что `$ref->some`. Т.к. объекты в `perl` – хэши, то для доступа к членам класса пишут стрелку) |
|70 - 96| объявляются хэши и инициализируются хэши (`[]` - ссылка на пустой список). Далее инициализируются переменные. После задаются обработчики сигналов(`\&` - создает ссылку на функцию), `srand` инициализирует генератор случайных чисел |
||`sub` – декларирует и/или определяет подпрограмму |
|98 - 103| `debug` – вызывается для отладки программы (включает режим отладки)|
|105 - 114| `save_data` – сохраняет данные в файлы. В ней вызывается `save_tome_file` и `save_karma_file` |
|116 - 122| `get_jid` – возвращает ник человека в комнате(после `//` указано значение по умолчанию, с которым должен работать `shift`; `shift` – удаляет первый элемент из массива и возвращает его значение; `defined` – определяет, содержит ли выражение какое-либо значение или нет)|
|124 - 131| `shutdown` – вызывает подпрограмму сохранения данных, выводит в консоль время работы и выходит из программы|
|133 - 147| `say_to` — сохраняет аргументы командной строки, отправляет сообщение(`lc` - преобразует все прописные буквы строкового параметра в строчные и возвращает строку; scalar – определяет число элементов в списке)|
|149 - 157|`give_role` – посылает команду jabber-серверу на выдачу роли человеку|
|159 - 184| `bomb_user` – сбрасывает все роли заданному пользователю в том чате, куда ему кинули бомбу («кинуть бомбу» - пользователю прилетает сообщение о том, что бот взорвет весь город, бот создает набор случайных проводов и один помечает как «верный». Если пользователь не угадал верный провод — он выбрасывается из чата; `split` – расщепляет строку на список подстрок по разделителю)|
|186 - 206| `background_checks` – проверяет, не истекли ли таймеры у бомб. Далее проверяет, не нужно ли обновить хэш `say_to` (после определенного времени удаляется),при необходимости «чистит» хэш (удаляет устаревшее)|
|208 - 620| `new_bot_message` - основная функция обработки пришедших сообщений|
|221 - 230| проверяется, есть ли в сообщении обращение к боту, если есть — выводит случайный ключ из `tome`|
|232 - 243| проверяет, если боту написали «голос» или «voice»,дает пользователю роль «participant»|
|245 - 247| проверяет текст по ключевым словам (при помощи `keywords.pm`) и отвечает, если нашлись совпадения | 
|261 - 620| команды, которые выполняет бот и отправляет в чат сообщения. `Given` – позволяет выполнить блок кода, если аргумент удовлетворяет указанному условию (аналог `switch`)|
|263 - 266| `top N` – выводит топ `N` пользователей с наибольшей кармой|
|268 - 287| `help` – показывает вспомогательное сообщение с командами|
|289 - 292| `karma user` – показывает карму пользователя|
|294 - 297| `bomb user` - «кидает бомбу» пользователю|
|299 - 304| `list-kickers` – перечисляет пользователей с правами «вышибал»|
|306 - 341| `sayto/user/message` – отправить личное сообщение пользователю|
|343 -348| `!word` - переводит (зачем(1)???)|
|350 - 358| `google` - гуглит (зачем(2)???)| 
|360 - 453| `http://uri` – показывает информацию о найденном URI (зачем(3)???)|
|455 - 470| удаляет бомбу|
|474 - 479| выбирает человека для сообщения по никнейму и отвечает, если найдены команда|
|481 - 484| `karma user` – показывает карму пользователя|
|486 - 545|  «кидает бомбу» пользователю, с проверками не кинул ли пользователь бомбу себе или не ыла ли уже установлена бомба. Если все в порядке, начинает отсчет до взрыва бомбы и посылает пользователю сообщение о начале игры|
|547 - 551| `user:++` или `user:+1` увеличивает карму пользователя|
|553 - 557| `user:--` или `user:-1` – уменьшает карму пользователя|
|559 - 570| `remove-kicker` – убирает пользователя из спискa|
|572 - 593| `add-kicker` – назначает пользователя «вышибалой»|
|583 - 593| `kick user` - «выбрасывает» пользователя|
|602 - 606| внезапная шутка от бота|
|608 - 612| при встрече в диалоге "баш" или "шутк" появляется шутка от бота|
|622 - 643| создается объект класса бота, которому на некоторые обработчики назначаются свои функции. Далее задается количество сообщений в час и стартует бот|
